# Story 4.1: Response Planning Mode

## Status
**Draft**

## Story
**As a** responder,  
**I want** to plan responses before delivery,  
**so that** resources can be prepared.

## Acceptance Criteria

1. Response form with "planned" status
2. Link to specific assessment (immutable)
3. Item details (name, unit, quantity)
4. Editable while in planned status
5. Multiple responders can access if assigned
6. Offline planning capability
7. Backend API for planned responses

## Tasks / Subtasks

- [ ] **Task 1: Create Response Planning Database Schema and API** (AC: 1, 2, 7)
  - [ ] Extend RapidResponse model with planning-specific fields (already exists but may need updates)
  - [ ] Create response planning API endpoint (`POST /api/v1/responses/planned`)
  - [ ] Create response retrieval endpoint (`GET /api/v1/responses/[id]`)
  - [ ] Create response update endpoint (`PUT /api/v1/responses/[id]`)
  - [ ] Add role-based access control for RESPONDER role operations
  - [ ] Implement validation schemas using Zod for response planning operations
  - [ ] Add audit logging for all response planning actions

- [ ] **Task 2: Implement Response Planning Form Component** (AC: 1, 3, 4)
  - [ ] Create ResponsePlanningForm component with planned status default
  - [ ] Add assessment selection dropdown (immutable once selected)
  - [ ] Implement dynamic item details input (name, unit, quantity)
  - [ ] Add form validation for required fields
  - [ ] Include save draft capability while planning
  - [ ] Add cancellation option to discard planned responses
  - [ ] Implement edit functionality for existing planned responses

- [ ] **Task 3: Create Response Planning Interface for Responders** (AC: 5, 6)
  - [ ] Create responder dashboard section for planned responses
  - [ ] Add response planning page in responder routes (`/responder/planning`)
  - [ ] Implement access control for assigned entity responses only
  - [ ] Add offline support for planning form completion
  - [ ] Include sync status indicators for planned responses
  - [ ] Add filtering and sorting capabilities for planned responses
  - [ ] Implement responsive design for mobile planning workflows

- [ ] **Task 4: Link Responses to Assessments** (AC: 2)
  - [ ] Create assessment selector component showing assigned assessments
  - [ ] Implement assessment details preview in response form
  - [ ] Add validation to ensure assessment is selected before planning
  - [ ] Create immutable link between planned response and assessment
  - [ ] Add assessment-to-response relationship tracking
  - [ ] Implement conflict prevention for multiple responses to same assessment

- [ ] **Task 5: Multi-Responder Access Control** (AC: 5)
  - [ ] Implement entity assignment validation for response access
  - [ ] Add concurrent editing detection for planned responses
  - [ ] Create responder collaboration features for shared planning
  - [ ] Add visibility indicators for other responders working on same response
  - [ ] Implement locking mechanism to prevent edit conflicts
  - [ ] Add audit trail for multi-responder collaboration

- [ ] **Task 6: Offline Planning Capabilities** (AC: 6)
  - [ ] Integrate with Dexie.js for offline response storage
  - [ ] Implement sync queue for planned responses when offline
  - [ ] Add offline status indicators in planning interface
  - [ ] Create conflict resolution for simultaneous offline planning
  - [ ] Add data validation on sync to prevent corruption
  - [ ] Implement retry logic for failed sync operations

- [ ] **Task 7: Comprehensive Testing Suite** (All ACs)
  - [ ] Unit tests for response planning API endpoints
  - [ ] Component testing for ResponsePlanningForm and related components
  - [ ] Integration tests for complete response planning workflows
  - [ ] Offline planning functionality testing
  - [ ] Multi-responder access control testing
  - [ ] Assessment linking validation testing
  - [ ] Performance testing for large response lists

## Dev Notes

### Previous Story Insights
From Story 3.3 completion:
- **Assessment Data Structure**: RapidAssessment model with verification status provides foundation for response planning
- **Authentication**: AuthService with role-based access control available for RESPONDER role
- **Entity Assignment**: EntityAssignmentService provides access control for assigned entities
- **Component Patterns**: Form components and field patterns established for assessment display can be adapted for responses
- **API Architecture**: Backend service patterns with Prisma transactions and audit logging established
- **Database Setup**: Critical to run `prisma db push` after schema changes (learned from 3.3 QA review)

### Database Schema
[Source: docs/architecture/6-database-schema-prisma.md lines 400-450]

**RapidResponse Model (Existing):**
```prisma
model RapidResponse {
  id           String         @id @default(uuid())
  assessmentId String         @map("assessment_id")
  entityId     String         @map("entity_id")
  responderId  String         @map("responder_id")
  donorId      String?        @map("donor_id") // Nullable
  
  // Status
  status             ResponseStatus     @default(PLANNED)
  plannedDate        Date               @map("planned_date")
  responseDate       DateTime?          @map("response_date")
  
  // Verification
  verificationStatus VerificationStatus @default(DRAFT) @map("verification_status")
  rejectionReason    String?            @map("rejection_reason")
  rejectionFeedback  String?            @db.Text @map("rejection_feedback")
  syncStatus         SyncStatus         @default(LOCAL) @map("sync_status")
  
  // Offline tracking
  offlineId     String? @unique @map("offline_id")
  versionNumber Int     @default(1) @map("version_number")
  
  // Response items (JSON array)
  items Json
  
  // Relationships
  assessment       RapidAssessment     @relation(fields: [assessmentId], references: [id])
  affectedEntity   AffectedEntity      @relation(fields: [entityId], references: [id])
  responder        User                @relation("ResponderRelation", fields: [responderId], references: [id])
  donor            Donor?              @relation(fields: [donorId], references: [id])
  mediaAttachments MediaAttachment[]
  conflicts        SyncConflict[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}
```

**ResponseStatus Enum:**
```prisma
enum ResponseStatus {
  PLANNED
  DELIVERED
}
```

**Key Insight**: The RapidResponse model already exists with PLANNED status and most required fields. The story primarily needs to implement the frontend interface and API endpoints for creating/managing planned responses.

### Authentication & Authorization
[Source: docs/architecture/9-backend-services.md lines 26-342]

**Available Middleware:**
- `withAuth()` - Authentication wrapper for API routes
- `requireRole('RESPONDER')` - Role-based access control for responders
- `requirePermission()` - Permission-based access control
- Full user context with roles and permissions available

**AuthService Capabilities:**
- User verification and role checking for RESPONDER operations
- Permission validation for response planning and entity access
- Token management and session handling

**Entity Assignment Validation:**
- Use existing EntityAssignmentService to validate responder access to entities
- Ensure responders can only plan responses for assigned entities
- Validate assessment-responder entity relationships

### Component Architecture Requirements
[Source: docs/architecture/11-component-architecture.md]

**Layout Components Available:**
- `AppShell` - Main application shell structure
- `Navigation` - Role-based navigation (includes responder routes)
- `RoleSwitcher` - Multi-role switching support

**Responder Navigation Structure:**
Based on existing coordinator patterns, responder navigation should include:
- Response Planning interface
- Response management pages
- Assigned entities access

**Form Component Patterns:**
- Follow established assessment form patterns for consistency
- Use React Hook Form with Zod validation
- Implement progressive validation as user completes forms
- Include draft saving and offline capabilities

### API Specifications
[Source: docs/architecture/9-backend-services.md]

**Response Planning Endpoints Pattern:**
- Role-based access control using `requireRole('RESPONDER')`
- Comprehensive audit logging for all response planning actions
- Error handling with structured response format
- Transaction support for data consistency

**Proposed API Endpoints:**
- `POST /api/v1/responses/planned` - Create new planned response
- `GET /api/v1/responses/[id]` - Get specific response details
- `PUT /api/v1/responses/[id]` - Update planned response (only if PLANNED status)
- `GET /api/v1/responses/planned/assigned` - Get planned responses for assigned entities
- `POST /api/v1/responses/[id]/submit` - Convert planned to delivered status

**Response Planning Data Flow:**
1. **Assessment Selection**: Choose verified assessment for entity
2. **Response Planning**: Create planned response with item details
3. **Draft Management**: Save and edit planned responses while status is PLANNED
4. **Access Control**: Validate responder entity assignments
5. **Multi-Responder**: Support collaboration on shared planned responses
6. **Offline Support**: Queue planned responses for sync when online

### Project Structure
[Source: docs/architecture/4-project-structure.md]

**API Routes**: `src/app/api/v1/responses/` - Response planning and management endpoints
**Responder Pages**: `src/app/(auth)/responder/planning/` - Main response planning interface
**Response Components**: `src/components/forms/response/` - Planning and delivery form components
**Services**: `src/lib/services/response.service.ts` - Response planning business logic layer
**Types**: `src/types/response.ts` - Response-specific interfaces
**Hooks**: `src/hooks/useResponse.ts` - Response planning operations and state

### Response Items Structure
Based on existing `items Json` field in RapidResponse model:

**Proposed JSON Structure:**
```typescript
interface ResponseItem {
  name: string;
  unit: string;
  quantity: number;
  category?: string; // Optional categorization
  notes?: string; // Additional planning notes
}
```

### Offline Strategy Integration
[Source: docs/architecture/13-offline-strategy.md]

**Dexie.js Integration:**
- Store planned responses in IndexedDB for offline access
- Sync queue for planned responses created offline
- Conflict resolution for simultaneous planning
- Data validation on sync completion

**Sync Engine Integration:**
- Use existing sync queue patterns from assessments
- Implement response-specific conflict resolution
- Add offline status indicators in planning interface
- Support background sync for planned responses

### Entity Assignment Validation
[Source: Previous story patterns and EntityAssignmentService]

**Validation Requirements:**
- Verify responder has assignment to target entity
- Ensure assessment is verified before response planning
- Validate assessment-responder-entity relationships
- Support multiple responders per entity
- Prevent unauthorized response planning

### Security Considerations

**Responder Access Control:**
- Verify responder role before allowing response planning access
- Ensure responders can only plan responses for assigned entities
- Validate assessment verification status before response planning
- Comprehensive audit trail for all response planning decisions

**Data Integrity:**
- Prevent response planning for non-existent assessments
- Block editing of delivered responses (only planned responses editable)
- Maintain data consistency with database transactions
- Handle concurrent planning attempts gracefully

**Assessment Link Integrity:**
- Immutable link between planned response and assessment
- Prevent assessment changes after response planning begins
- Validate assessment-responder-entity relationships
- Audit trail for assessment-response linking

### Performance Requirements

**Response Planning Interface:**
- Fast loading of assigned assessments and entities
- Efficient pagination for large response lists
- Lazy loading for response details
- Caching for frequently accessed data

**Multi-Responder Performance:**
- Efficient concurrent access handling
- Minimal latency for response planning actions
- Optimistic updates for better user experience
- Background processing for non-critical operations

### File Locations
[Source: docs/architecture/4-project-structure.md]
- **API Routes**: `src/app/api/v1/responses/` - Response planning endpoints
- **Responder Pages**: `src/app/(auth)/responder/planning/` - Planning interface
- **Response Components**: `src/components/forms/response/` - Planning form components
- **Response Service**: `src/lib/services/response.service.ts` - Business logic
- **Response Types**: `src/types/response.ts` - Response interfaces
- **Response Hooks**: `src/hooks/useResponse.ts` - Response operations
- **Offline Integration**: Extend existing `src/lib/sync/` for response sync

### Technology Integration
[Source: docs/architecture/2-technology-stack.md]

**Frontend Technologies:**
- React Hook Form with Zod validation for planning forms
- Zustand for response planning state management
- TanStack Query for server state and caching
- Dexie.js for offline response storage

**Backend Technologies:**
- Prisma for database operations with RapidResponse model
- Next.js API Routes with proper authentication middleware
- PostgreSQL with JSON support for response items

## Testing

### Test File Locations
- Unit tests: `tests/unit/responses/` - Response planning API and service logic
- Component tests: `tests/components/responses/` - Planning form and interface components
- Integration tests: `tests/integration/responses/` - Complete response planning workflows
- E2E tests: `tests/e2e/response-planning.test.ts` - Responder planning scenarios

### Testing Standards
[Source: docs/prd/testing-strategy.md]
- **No Frontend Mocks**: All response planning data from backend APIs
- **Integration Testing**: Response planning API endpoints with database operations
- **Component Testing**: Response planning forms and interface components
- **E2E Testing**: Complete response planning workflows including offline scenarios
- **Security Testing**: RESPONDER role validation and entity assignment permissions
- **Offline Testing**: Planning form completion and sync scenarios

### Testing Frameworks
- **Jest**: Unit and integration testing for response planning business logic
- **React Testing Library**: Component testing for planning forms and interfaces
- **Playwright**: End-to-end response planning workflow testing
- **MSW**: Mock response planning APIs for consistent test scenarios

### Key Test Scenarios
1. **Response Planning Form**: Form validation, item details input, draft saving
2. **Assessment Linking**: Assessment selection, immutable linking, validation
3. **Entity Assignment Access**: Responder access control, assignment validation
4. **Multi-Responder Planning**: Concurrent access, collaboration features
5. **Offline Planning**: Form completion offline, sync queue, conflict resolution
6. **Status Management**: PLANNED status updates, edit capabilities, status transitions
7. **API Integration**: All response planning endpoints with proper authentication
8. **Data Validation**: Response items structure, assessment link integrity

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation with complete technical context and Epic 4 requirements | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*