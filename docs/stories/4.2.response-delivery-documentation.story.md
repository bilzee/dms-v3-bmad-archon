# Story 4.2: Response Delivery Documentation

## Status
**Approved** - Validated and ready for development

## Story
**As a** responder,  
**I want** to document actual deliveries,  
**so that** aid distribution is tracked.

## Acceptance Criteria

1. Convert planned to delivered status
2. Edit capability before delivery
3. No re-entry of data required
4. Auto-submission for verification
5. GPS and timestamp capture
6. Media attachment for proof
7. Backend integration tests

## Tasks / Subtasks

- [ ] **Task 1: Response Delivery Status Management** (AC: 1, 2, 3)
  - [ ] Extend response API to support PLANNED → DELIVERED status transition
  - [ ] Create delivery confirmation interface for responders
  - [ ] Implement pre-delivery editing capabilities for planned responses
  - [ ] Add delivery validation and confirmation workflow
  - [ ] Ensure no data re-entry required - inherit from planned response data
  - [ ] Add role-based access control for delivery operations (RESPONDER only)

- [ ] **Task 2: Delivery Documentation Interface** (AC: 4, 5, 6)
  - [ ] Create delivery confirmation form component
  - [ ] Implement GPS coordinate capture at delivery time using browser geolocation
  - [ ] Add automatic timestamp capture for delivery documentation
  - [ ] Build media attachment interface using existing MediaAttachment model
  - [ ] Create delivery notes and observations field
  - [ ] Add delivery verification and preview before submission

- [ ] **Task 3: Auto-Submission for Verification** (AC: 4)
  - [ ] Implement automatic status change to SUBMITTED verification upon delivery
  - [ ] Create delivery verification queue submission logic (separate from assessment queue)
  - [ ] Add audit trail generation for delivery completion
  - [ ] Build notification system for coordinators about new deliveries
  - [ ] Integrate with existing VerificationService for auto-submission
  - [ ] Add delivery confirmation receipts for responders

- [ ] **Task 4: Separate Delivery Verification Queue** (AC: 4, 7)
  - [ ] Create `GET /api/v1/verification/queue/deliveries` endpoint for coordinator delivery queue
  - [ ] Implement delivery queue filtering (status, entity, responder, date range)
  - [ ] Build delivery verification interface separate from assessment queue
  - [ ] Add delivery-specific verification actions (approve, reject, request more info)
  - [ ] Create delivery verification metrics and reporting
  - [ ] Implement delivery queue real-time updates and notifications

- [ ] **Task 5: Backend API Enhancements** (AC: 1, 4, 7)
  - [ ] Create `POST /api/v1/responses/[id]/deliver` endpoint for delivery confirmation
  - [ ] Implement `PUT /api/v1/responses/[id]` endpoint for pre-delivery editing
  - [ ] Add delivery metadata capture (GPS coordinates, timestamp)
  - [ ] Create delivery validation using existing response service patterns
  - [ ] Implement comprehensive audit logging for delivery operations
  - [ ] Add database transaction support for delivery status changes

- [ ] **Task 6: Media Attachment System for Delivery Proof** (AC: 6)
  - [ ] Use existing MediaAttachment model for delivery documentation
  - [ ] Create delivery photo capture interface
  - [ ] Implement media upload for delivery proof using current schema
  - [ ] Add media preview and management in delivery confirmation
  - [ ] Build offline support for delivery photos with sync queue
  - [ ] Store GPS coordinates separately in response metadata

- [ ] **Task 7: Offline Delivery Documentation Support** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Extend ResponseOfflineService to support delivery operations offline
  - [ ] Implement offline delivery confirmation with GPS and media capture
  - [ ] Add offline queue for delivery documentation when connectivity restored
  - [ ] Create conflict resolution for simultaneous delivery attempts
  - [ ] Build offline status indicators for delivery documentation
  - [ ] Add sync progress indicators for delivery documentation uploads

- [ ] **Task 8: Comprehensive Testing Suite** (All ACs)
  - [ ] Unit tests for delivery status transition logic
  - [ ] Integration tests for delivery API endpoints
  - [ ] Component tests for delivery confirmation interface
  - [ ] E2E tests for complete delivery documentation workflow
  - [ ] Offline delivery documentation testing with sync scenarios
  - [ ] Media attachment testing using current schema
  - [ ] Auto-submission to verification queue testing
  - [ ] Performance testing for delivery documentation operations

## Dev Notes

### Database Schema - Current RapidResponse Model
Based on existing Prisma schema, the RapidResponse model already supports delivery documentation:

```prisma
model RapidResponse {
  id                 String             @id @default(uuid())
  responderId        String
  entityId           String
  assessmentId       String
  status             ResponseStatus     @default(PLANNED)  // PLANNED → DELIVERED
  verificationStatus VerificationStatus @default(DRAFT)   // DRAFT → SUBMITTED
  responseDate       DateTime?                            // Capture delivery timestamp
  items              Json                                 // Inherit from planning
  mediaAttachments   MediaAttachment[]                   // For delivery proof photos
  // ... other fields
}

enum ResponseStatus {
  PLANNED    // Current state from Story 4.1
  DELIVERED  // Target state for this story
}

enum VerificationStatus {
  DRAFT
  SUBMITTED  // Use for verification queue
  VERIFIED
  AUTO_VERIFIED
  REJECTED
}
```

### MediaAttachment Model - Current Schema
```prisma
model MediaAttachment {
  id            String        @id @default(uuid())
  responseId    String
  filename      String
  originalName  String
  mimeType      String
  fileSize      Int
  filePath      String
  thumbnailPath String?
  uploadedAt    DateTime      @default(now())
  uploadedBy    String
  response      RapidResponse @relation(fields: [responseId], references: [id])
}
```

**Note**: GPS metadata will be stored in RapidResponse.responseDate and separate GPS fields if needed, not in MediaAttachment.

### API Endpoints Required
- `POST /api/v1/responses/[id]/deliver` - Confirm delivery with GPS/timestamp
- `PUT /api/v1/responses/[id]` - Edit planned response before delivery
- `GET /api/v1/verification/queue/deliveries` - Delivery verification queue

### Authentication & Authorization
- Use existing AuthService with `requireRole('RESPONDER')` for delivery operations
- Use existing EntityAssignmentService to validate responder access to entities
- Comprehensive audit logging using existing AuditLog model

### Frontend Component Architecture
- Adapt existing ResponsePlanningForm patterns for DeliveryConfirmationForm
- Use React Hook Form with Zod validation
- Implement progressive validation and offline capabilities
- GPS capture using browser geolocation API

### Offline Strategy
- Use existing Dexie.js integration for offline storage
- Extend ResponseOfflineService for delivery operations
- Implement sync queue for delivery confirmations when offline

## Testing

### Testing Strategy Alignment
Following `docs/prd/testing-strategy.md`:

**Unit Tests (Vitest):**
- Delivery status transition logic
- GPS coordinate validation
- Media attachment processing
- Form validation logic

**Integration Tests (Real Database):**
- Delivery confirmation API endpoints
- Database transactions and audit trail
- Media upload with delivery proof
- Role-based access control validation

**Component Tests (Testing Library):**
- DeliveryConfirmationForm with GPS capture
- Media attachment interface
- Offline sync indicators
- Responsive design validation

**E2E Tests (Playwright):**
- Complete delivery workflow from planning to verification
- Offline functionality with sync
- GPS capture and media upload
- Cross-browser compatibility

### Test File Locations
- `tests/unit/delivery-confirmation.test.ts`
- `tests/integration/delivery-api.test.ts`
- `tests/components/DeliveryConfirmationForm.test.tsx`
- `tests/e2e/delivery-workflow.spec.ts`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-02 | 2.0 | Corrected story aligned with current Prisma schema and template compliance | Product Owner Sarah |
| 2025-01-02 | 2.1 | Validated and approved - ready for development implementation | Product Owner Sarah |

## Dev Agent Record

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled by development agent*

### Completion Notes List
*To be filled by development agent*

### File List
*To be filled by development agent*

## QA Results
*To be filled by QA agent*