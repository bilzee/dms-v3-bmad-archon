# Story 3.2: Rapid Assessment Forms (All 6 Types)

## Status
**Approved**

## Story
**As an** assessor,  
**I want** to complete rapid assessments for all categories,  
**so that** entity needs are documented.

## Acceptance Criteria

1. Six assessment forms (Health, WASH, Shelter, Food, Security, Population)
2. Boolean fields for gap analysis
3. GPS and timestamp auto-capture
4. Media attachment per assessment
5. Offline completion for all forms
6. Progressive validation
7. Only assigned entities accessible
8. Backend integration for all assessment types

## Tasks / Subtasks

- [ ] **Task 1: Create Rapid Assessment API Endpoints** (AC: 8)
  - [ ] Create rapid assessment creation endpoint (`POST /api/v1/rapid-assessments`)
  - [ ] Create rapid assessment retrieval endpoint (`GET /api/v1/rapid-assessments/:id`)
  - [ ] Create assessor's rapid assessments list endpoint (`GET /api/v1/rapid-assessments/user/:userId`)
  - [ ] Create rapid assessment update endpoint (`PUT /api/v1/rapid-assessments/:id`)
  - [ ] Add role-based access control middleware for assessor operations
  - [ ] Implement validation schemas using Zod for all assessment types

- [ ] **Task 2: Implement Six Rapid Assessment Form Components** (AC: 1, 2, 6)
  - [ ] Create HealthAssessmentForm component with boolean gap fields
  - [ ] Create WASHAssessmentForm component with water/sanitation fields
  - [ ] Create ShelterAssessmentForm component with housing safety fields
  - [ ] Create FoodAssessmentForm component with nutrition/food security fields
  - [ ] Create SecurityAssessmentForm component with protection/safety fields
  - [ ] Create PopulationAssessmentForm component with demographic fields
  - [ ] Add progressive validation for all form types
  - [ ] Implement form navigation and type selection

- [ ] **Task 3: GPS and Media Integration** (AC: 3, 4)
  - [ ] Integrate GPSCapture component for automatic coordinate capture
  - [ ] Add manual GPS fallback for all assessment forms
  - [ ] Integrate MediaField component for photo attachments
  - [ ] Add location stamping for media files
  - [ ] Implement timestamp auto-capture for all assessments

- [ ] **Task 4: Entity Assignment Integration** (AC: 7)
  - [ ] Integrate with entity assignment system to filter accessible entities
  - [ ] Add entity selection component based on user assignments
  - [ ] Implement entity-specific assessment routing
  - [ ] Add assignment validation middleware

- [ ] **Task 5: Offline Support and Synchronization** (AC: 5)
  - [ ] Create rapid assessment Zustand store with offline capabilities
  - [ ] Implement IndexedDB storage for draft assessments
  - [ ] Add offline queue management for assessment submissions
  - [ ] Create sync conflict resolution for assessments
  - [ ] Add offline status indicators and user feedback

- [ ] **Task 6: Comprehensive Testing Suite** (All ACs)
  - [ ] Unit tests for all assessment form components
  - [ ] Integration tests for assessment API endpoints
  - [ ] E2E tests for complete assessment workflows
  - [ ] Offline functionality testing for all form types
  - [ ] GPS capture and media attachment testing

## Dev Notes

### Previous Story Insights
From Story 3.1 completion:
- **GPS Component**: GPSCapture.tsx already implemented with automatic and manual coordinate capture
- **Media Upload**: MediaField component exists for photo attachments with location stamping
- **Offline Architecture**: Zustand + IndexedDB pattern proven effective for assessments
- **Form Validation**: React Hook Form + Zod validation pattern established
- **Entity Assignment**: EntityAssignmentService provides user entity filtering
- **Infrastructure**: Missing UI components (Avatar, Tooltip, Command, Popover) identified as blockers

### Database Schema
[Source: prisma/schema.prisma lines 175-199]

**RapidAssessment Model:**
```prisma
model RapidAssessment {
  id              String          @id @default(cuid())
  assessorId      String
  entityId        String
  type            AssessmentType
  priority        Priority        @default(MEDIUM)
  status          AssessmentStatus @default(DRAFT)
  location        String?
  coordinates     Json?
  data            Json            // Assessment form data stored here
  versionNumber   Int             @default(1)
  isOfflineCreated Boolean        @default(false)
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt      DateTime?
  verifiedBy      String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relationships
  assessor        User     @relation(fields: [assessorId], references: [id])
  entity          Entity   @relation(fields: [entityId], references: [id])
  responses       RapidResponse[]
}
```

**Assessment Types Enum:**
```prisma
enum AssessmentType {
  RAPID_HEALTH
  RAPID_WASH
  RAPID_SHELTER
  RAPID_FOOD
  RAPID_PROTECTION
  RAPID_EDUCATION
}
```

**Note:** The schema uses `RAPID_PROTECTION` (Security) and `RAPID_EDUCATION` (Population) - these correspond to the story requirements.

### Component Architecture Requirements
[Source: docs/architecture/11-component-architecture.md]

**Form Field Components Available:**
- **BooleanField**: Perfect for gap analysis with visual indicators (red/green when false/true)
- **GPSField**: Automatic GPS capture with manual fallback
- **MediaField**: Photo attachment with preview and location stamping
- **Reusable field patterns**: Established patterns for form validation and user feedback

**Assessment Form Structure:**
Each assessment form should follow the established pattern from HealthAssessmentForm example:
- Boolean fields for gap indicators with visual feedback
- Quantity fields for numerical data
- GPS coordinate capture (auto + manual)
- Media attachment support
- Progressive validation
- Offline draft saving

### API Specifications
[Source: docs/architecture/9-backend-services.md]

**Entity Assignment Integration:**
- Use `EntityAssignmentService.isUserAssigned()` to validate access
- Filter entities by user assignments before allowing assessment creation
- Role-based access control with `requireRole('ASSESSOR')`

**Assessment Data Structure:**
```typescript
interface AssessmentData {
  // Boolean gap fields (vary by assessment type)
  hasFunctionalClinic: boolean;        // Health
  isWaterSufficient: boolean;          // WASH
  areSheltersSufficient: boolean;      // Shelter
  isFoodSufficient: boolean;           // Food
  isSafeFromViolence: boolean;         // Security/Protection
  
  // Quantity fields
  numberHealthFacilities: number;
  qualifiedHealthWorkers: number;
  
  // GPS and metadata
  gpsCoordinates: {
    latitude: number;
    longitude: number;
    accuracy?: number;
    timestamp: Date;
    captureMethod: 'GPS' | 'MANUAL';
  };
  
  // Media attachments
  photos: File[];
  
  // Additional details
  additionalDetails?: string;
}
```

### Project Structure
[Source: docs/architecture/4-project-structure.md]

**API Routes**: `src/app/api/v1/rapid-assessments/` - All rapid assessment endpoints
**Form Components**: `src/components/forms/assessment/` - Six assessment form components
**Assessment Store**: `src/stores/rapid-assessment.store.ts` - Rapid assessment state management
**Assessment Types**: `src/types/rapid-assessment.ts` - Rapid assessment interfaces
**Assessment Hooks**: `src/hooks/useRapidAssessment.ts` - Rapid assessment operations
**Pages**: `src/app/(auth)/assessor/rapid-assessments/` - Assessment page components

### Gap Analysis Implementation
[Source: docs/architecture/9-backend-services.md lines 395-612]

**Gap Field Mappings:**
Each assessment type has specific boolean fields that indicate gaps when FALSE:

**Health (RAPID_HEALTH):**
- `hasFunctionalClinic`
- `hasEmergencyServices` 
- `hasMedicalSupplies`
- `hasTrainedStaff`

**WASH (RAPID_WASH):**
- `isWaterSufficient`
- `hasCleanWaterAccess`
- `areLatrinesSufficient`
- `hasHandwashingFacilities`

**Shelter (RAPID_SHELTER):**
- `areSheltersSufficient`
- `hasSafeStructures`
- `hasWeatherProtection`

**Food (RAPID_FOOD):**
- `isFoodSufficient`
- `hasRegularMealAccess`
- `hasInfantNutrition`

**Security/Protection (RAPID_PROTECTION):**
- `isSafeFromViolence`
- `hasSecurityPresence`
- `hasLighting`

**Population/Education (RAPID_EDUCATION):**
- No boolean gaps - focus on demographic data

### Offline Strategy Requirements
[Source: docs/architecture/13-offline-strategy.md]

**IndexedDB Storage:**
- **Draft Storage**: Save assessment drafts locally with auto-save capability
- **Media Caching**: Store captured media files for offline access
- **Queue Management**: Queue completed assessments for sync when online
- **Form State Persistence**: Maintain form data across app restarts

**Sync Engine Integration:**
- **Queue Operations**: Add rapid assessments to sync queue
- **Status Tracking**: Visual indicators for sync status (pending, syncing, synced, failed)
- **Retry Logic**: Exponential backoff for failed sync attempts
- **Conflict Resolution**: Handle server conflicts during sync

### Security Considerations

**Assessment Access Control:**
- Verify assessor role before allowing rapid assessment creation
- Enforce entity assignment validation - assessors can only create assessments for assigned entities
- Validate assessment data thoroughly before storage
- Audit trail for all assessment creation and modification activities

**Media Security:**
- Validate uploaded file types and sizes
- Scan uploaded files for security threats
- Secure media storage with proper access controls
- Handle media file permissions based on entity assignments

### File Locations
[Source: docs/architecture/4-project-structure.md]
- **API Routes**: `src/app/api/v1/rapid-assessments/` - All rapid assessment endpoints
- **Form Components**: `src/components/forms/assessment/` - Six assessment form components
- **GPS Component**: `src/components/shared/GPSCapture.tsx` - GPS coordinate capture (reuse from Story 3.1)
- **Media Component**: `src/components/shared/MediaField.tsx` - Media attachment (reuse from Story 3.1)
- **Assessment Store**: `src/stores/rapid-assessment.store.ts` - Rapid assessment state management
- **Assessment Types**: `src/types/rapid-assessment.ts` - Rapid assessment interfaces
- **Assessment Hooks**: `src/hooks/useRapidAssessment.ts` - Assessment operations
- **Pages**: `src/app/(auth)/assessor/rapid-assessments/` - Main assessment pages

## Testing

### Test File Locations
- Unit tests: `tests/unit/rapid-assessments/` - Form components and business logic
- API tests: `tests/unit/api/rapid-assessment-endpoints.test.ts` - API endpoint testing
- Integration tests: `tests/integration/rapid-assessments/workflows.test.ts` - Complete workflows
- E2E tests: `tests/e2e/rapid-assessment-workflows.test.ts` - User journey testing

### Testing Standards
[Source: docs/prd/testing-strategy.md]
- **No Frontend Mocks**: All assessment data from backend APIs
- **Integration Testing**: Assessment API endpoints with database operations
- **Component Testing**: Assessment form interfaces with GPS and media components
- **E2E Testing**: Complete rapid assessment workflows including offline scenarios
- **Offline Testing**: Sync functionality and conflict resolution

### Testing Frameworks
- **Jest**: Unit and integration testing for assessment business logic
- **React Testing Library**: Component testing for assessment forms and field components
- **Playwright**: End-to-end assessment workflow testing
- **MSW**: Mock assessment APIs for consistent test scenarios

### Key Test Scenarios
1. **Six Form Types**: Verify all six assessment forms render and function correctly
2. **Gap Analysis**: Test boolean field indicators and gap visualization
3. **GPS Integration**: Test automatic GPS capture and manual coordinate fallback
4. **Media Attachment**: Test photo upload with location stamping
5. **Entity Assignment**: Validate entity filtering based on user assignments
6. **Offline Functionality**: Test offline form completion and draft saving
7. **Progressive Validation**: Test form validation patterns across all assessment types
8. **Sync Operations**: Test offline-to-online synchronization with conflict resolution

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Initial story creation with complete technical context and Epic 3 requirements | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
- **Model**: [To be filled by Dev Agent]
- **Implementation Date**: [To be filled by Dev Agent]
- **Session Context**: [To be filled by Dev Agent]

### Debug Log References
- [To be filled by Dev Agent]

### Completion Notes List
- [To be filled by Dev Agent]

### File List
#### API & Services
- [To be filled by Dev Agent]

#### Components
- [To be filled by Dev Agent]

#### State Management
- [To be filled by Dev Agent]

#### Pages
- [To be filled by Dev Agent]

#### Testing
- [To be filled by Dev Agent]

## QA Results

### Review Date: [To be filled by QA Agent]

### Reviewed By: [To be filled by QA Agent]

### Code Quality Assessment
[To be filled by QA Agent]

### Gate Status
Gate: **[To be determined by QA Agent]**  

### Recommended Status
[To be filled by QA Agent]