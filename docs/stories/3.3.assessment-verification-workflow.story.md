# Story 3.3: Assessment Verification Workflow

## Status
**Draft**

## Story
**As a** coordinator,  
**I want** to verify or reject assessments,  
**so that** data quality is maintained.

## Acceptance Criteria

1. Verification queue in Crisis Management Dashboard
2. Expandable assessment details
3. Inline approve/reject actions
4. Structured rejection reasons
5. Feedback text for rejections
6. Auto-approval configuration per entity
7. Status indicators (Verified/Auto-approved/Pending/Rejected)
8. Backend API for verification actions

## Tasks / Subtasks

- [ ] **Task 1: Create Assessment Verification API Endpoints** (AC: 8)
  - [ ] Create assessment verification endpoint (`POST /api/v1/assessments/[id]/verify`)
  - [ ] Create assessment rejection endpoint (`POST /api/v1/assessments/[id]/reject`)
  - [ ] Create verification queue endpoint (`GET /api/v1/verification/queue/assessments`)
  - [ ] Add role-based access control middleware for coordinator operations
  - [ ] Implement validation schemas using Zod for verification operations
  - [ ] Add audit logging for all verification actions

- [ ] **Task 2: Implement Verification Queue Component** (AC: 1, 2)
  - [ ] Create VerificationQueue component with real-time updates
  - [ ] Add expandable assessment detail views
  - [ ] Implement filtering and sorting capabilities
  - [ ] Add pagination for large verification queues
  - [ ] Include status indicators and queue depth metrics
  - [ ] Add refresh functionality and automatic updates

- [ ] **Task 3: Create Inline Verification Actions** (AC: 3, 4, 5)
  - [ ] Implement approve/reject action buttons inline in queue
  - [ ] Create structured rejection reason selector
  - [ ] Add feedback text component for rejections
  - [ ] Include confirmation dialogs for verification actions
  - [ ] Add bulk verification capabilities for efficiency
  - [ ] Implement undo functionality for recent actions

- [ ] **Task 4: Auto-Approval Configuration System** (AC: 6)
  - [ ] Create AutoApprovalConfig component for entity settings
  - [ ] Implement per-entity auto-approval toggle
  - [ ] Add global auto-approval settings interface
  - [ ] Create audit trail for auto-approval changes
  - [ ] Add validation to prevent auto-approval conflicts
  - [ ] Implement auto-approval status indicators

- [ ] **Task 5: Status Management and Display** (AC: 7)
  - [ ] Create StatusIndicator component for assessment states
  - [ ] Implement visual indicators for all verification statuses
  - [ ] Add status transition animations and feedback
  - [ ] Create status history view for assessments
  - [ ] Implement status filtering in verification queue
  - [ ] Add status change notifications

- [ ] **Task 6: Integration with Crisis Management Dashboard** (AC: 1)
  - [ ] Create VerificationDashboard page component
  - [ ] Integrate verification queue into coordinator navigation
  - [ ] Add dashboard metrics and performance indicators
  - [ ] Implement real-time updates using WebSocket or polling
  - [ ] Add responsive design for mobile devices
  - [ ] Include accessibility features for verification workflow

- [ ] **Task 7: Comprehensive Testing Suite** (All ACs)
  - [ ] Unit tests for verification API endpoints
  - [ ] Component testing for verification queue components
  - [ ] Integration tests for complete verification workflows
  - [ ] Auto-approval configuration testing
  - [ ] E2E tests for coordinator verification scenarios
  - [ ] Performance testing for large verification queues

## Dev Notes

### Previous Story Insights
From Story 3.2 completion:
- **Assessment Data Structure**: RapidAssessment model with verification status already implemented
- **Authentication**: AuthService with role-based access control available for COORDINATOR role
- **Entity Assignment**: EntityAssignmentService provides access control for assigned entities
- **Component Patterns**: Form components and field patterns established for assessment display
- **API Architecture**: Backend service patterns with Prisma transactions and audit logging

### Database Schema
[Source: docs/architecture/6-database-schema-prisma.md lines 310-350]

**RapidAssessment Model (Relevant Fields):**
```prisma
model RapidAssessment {
  id             String         @id @default(uuid())
  entityId       String         @map("entity_id")
  incidentId     String         @map("incident_id")
  assessorId     String         @map("assessor_id")
  assessmentType AssessmentType @map("assessment_type")
  assessmentDate Date           @map("assessment_date")
  
  // Status fields for verification
  verificationStatus VerificationStatus @default(PENDING) @map("verification_status")
  rejectionReason    String?            @map("rejection_reason")
  rejectionFeedback  String?            @db.Text @map("rejection_feedback")
  
  // Relationships
  affectedEntity   AffectedEntity    @relation(fields: [entityId], references: [id])
  incident         Incident          @relation(fields: [incidentId], references: [id])
  assessor         User              @relation("AssessorRelation", fields: [assessorId], references: [id])
  responses        RapidResponse[]
  mediaAttachments MediaAttachment[]
  conflicts        SyncConflict[]
  
  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}
```

**VerificationStatus Enum:**
```prisma
enum VerificationStatus {
  DRAFT         // Initial state
  PENDING       // Awaiting verification
  VERIFIED      // Approved by coordinator
  AUTO_VERIFIED // Automatically approved
  REJECTED      // Rejected by coordinator
}
```

**AffectedEntity Auto-Approval Field:**
```prisma
model AffectedEntity {
  // Auto-approval
  autoApproveEnabled Boolean @default(false) @map("auto_approve_enabled")
}
```

### Verification Service Architecture
[Source: docs/architecture/9-backend-services.md lines 615-909]

**VerificationService Available:**
- `verifyAssessment()` - Approve/reject assessments with audit logging
- `getVerificationQueue()` - Paginated verification queue retrieval
- `updateDonorMetrics()` - Performance metrics updates (for response verification)
- Comprehensive audit logging for all verification actions
- Auto-approval support with conflict prevention

**AutoApprovalService Available:**
- `autoApproveResponse()` - Auto-approval for responses (extend pattern for assessments)
- `toggleEntityAutoApproval()` - Entity-level auto-approval configuration
- Audit trail for auto-approval changes

### Authentication & Authorization
[Source: docs/architecture/9-backend-services.md lines 26-342]

**Available Middleware:**
- `withAuth()` - Authentication wrapper for API routes
- `requireRole('COORDINATOR')` - Role-based access control
- `requirePermission()` - Permission-based access control
- Full user context with roles and permissions available

**AuthService Capabilities:**
- User verification and role checking
- Permission validation for coordinator operations
- Token management and session handling

### Component Architecture Requirements
[Source: docs/architecture/11-component-architecture.md]

**Layout Components Available:**
- `AppShell` - Main application shell structure
- `Navigation` - Role-based navigation (includes coordinator routes)
- `RoleSwitcher` - Multi-role switching support

**Coordinator Navigation:**
```typescript
COORDINATOR: [
  { label: 'Crisis Dashboard', path: '/coordinator/dashboard', icon: AlertTriangle },
  { label: 'Verification', path: '/coordinator/verification', icon: CheckCircle },
  { label: 'Monitoring', path: '/coordinator/monitoring', icon: TrendingUp },
  { label: 'Incidents', path: '/coordinator/incidents', icon: AlertTriangle },
  { label: 'Entities', path: '/coordinator/entities', icon: MapPin },
]
```

**Shared Components Available:**
- `OfflineIndicator` - Online/offline status display
- `SyncIndicator` - Sync queue status and management
- Form field components for assessment data display

### API Specifications
[Source: docs/architecture/9-backend-services.md]

**Verification Endpoints Pattern:**
- Role-based access control using `requireRole('COORDINATOR')`
- Comprehensive audit logging for all verification actions
- Error handling with structured response format
- Transaction support for data consistency

**Verification Data Flow:**
1. **Queue Retrieval**: Get paginated list of pending assessments
2. **Detail Expansion**: Show full assessment data with entity and assessor info
3. **Verification Action**: Approve/reject with optional reasons
4. **Status Update**: Update verification status with audit trail
5. **Notification**: Trigger notifications for assessor if needed

### Project Structure
[Source: docs/architecture/4-project-structure.md]

**API Routes**: `src/app/api/v1/verification/` - Verification-specific endpoints
**Coordinator Pages**: `src/app/(auth)/coordinator/verification/` - Main verification dashboard
**Verification Components**: `src/components/verification/` - Queue and action components
**Services**: `src/lib/services/verification.service.ts` - Business logic layer
**Types**: `src/types/verification.ts` - Verification-specific interfaces
**Hooks**: `src/hooks/useVerification.ts` - Verification operations and state

### Real-Time Updates Requirements
**Dashboard Update Strategy:**
- WebSocket or polling for real-time queue updates
- Visual indicators for new pending assessments
- Auto-refresh capabilities with configurable intervals
- Performance considerations for large datasets

**Status Change Notifications:**
- Immediate UI updates when verification actions occur
- Visual feedback for successful actions
- Error handling and retry mechanisms
- Conflict resolution for simultaneous actions

### Security Considerations

**Coordinator Access Control:**
- Verify coordinator role before allowing verification access
- Ensure coordinators can only verify assigned entities (if applicable)
- Validate assessment data before status changes
- Comprehensive audit trail for all verification decisions

**Data Integrity:**
- Prevent verification of already verified assessments
- Block rejection of auto-approved items
- Maintain data consistency with database transactions
- Handle concurrent verification attempts gracefully

### Performance Requirements

**Queue Management:**
- Efficient pagination for large verification queues
- Lazy loading for assessment details
- Caching for frequently accessed data
- Optimized database queries with proper indexing

**Real-Time Performance:**
- Minimal latency for verification actions
- Efficient state updates across components
- Background processing for non-critical operations
- Performance monitoring and optimization

### File Locations
[Source: docs/architecture/4-project-structure.md]
- **API Routes**: `src/app/api/v1/verification/` - Verification endpoints
- **Coordinator Pages**: `src/app/(auth)/coordinator/verification/` - Verification dashboard
- **Verification Components**: `src/components/verification/` - Queue and action components
- **Verification Service**: `src/lib/services/verification.service.ts` - Business logic (extend existing)
- **Verification Types**: `src/types/verification.ts` - Verification interfaces
- **Verification Hooks**: `src/hooks/useVerification.ts` - Verification operations
- **Auto-Approval Components**: `src/components/verification/auto-approval/` - Configuration components

## Testing

### Test File Locations
- Unit tests: `tests/unit/verification/` - Verification API and service logic
- Component tests: `tests/components/verification/` - Queue and action components
- Integration tests: `tests/integration/verification/` - Complete verification workflows
- E2E tests: `tests/e2e/verification-workflows.test.ts` - Coordinator scenarios

### Testing Standards
[Source: docs/prd/testing-strategy.md]
- **No Frontend Mocks**: All verification data from backend APIs
- **Integration Testing**: Verification API endpoints with database operations
- **Component Testing**: Verification queue interfaces and action components
- **E2E Testing**: Complete verification workflows including approval/rejection scenarios
- **Security Testing**: Role-based access control and permission validation

### Testing Frameworks
- **Jest**: Unit and integration testing for verification business logic
- **React Testing Library**: Component testing for verification queue and actions
- **Playwright**: End-to-end verification workflow testing
- **MSW**: Mock verification APIs for consistent test scenarios

### Key Test Scenarios
1. **Verification Queue**: Queue loading, pagination, filtering, and sorting
2. **Assessment Details**: Expandable views with complete assessment information
3. **Approval Actions**: Inline approval with proper status updates and audit logging
4. **Rejection Actions**: Structured rejection reasons with feedback text
5. **Auto-Approval**: Entity-level configuration and status indicators
6. **Real-Time Updates**: Queue updates and status change notifications
7. **Access Control**: Coordinator role validation and permission checks
8. **Performance**: Large queue handling and efficient data loading

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Initial story creation with complete technical context and Epic 3 requirements | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
- **Model**: [To be populated by Dev Agent]
- **Implementation Date**: [To be populated by Dev Agent]
- **Session Context**: [To be populated by Dev Agent]

### Debug Log References
- [To be populated by Dev Agent]

### Completion Notes List
- [To be populated by Dev Agent]

### File List
- [To be populated by Dev Agent]

## QA Results

### Review Date: [To be populated by QA Agent]

### Reviewed By: [To be populated by QA Agent]

### Code Quality Assessment
- [To be populated by QA Agent]

### Gate Status
Gate: **[PENDING]**

### Recommended Status
**[PENDING]** - Story ready for development implementation.