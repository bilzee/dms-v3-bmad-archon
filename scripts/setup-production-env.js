#!/usr/bin/env node

/**
 * Production Environment Setup Script for DRMS
 * Generates secure secrets and validates environment configuration
 */

const fs = require('fs');
const crypto = require('crypto');
const readline = require('readline');

console.log('üîß Setting up production environment for Disaster Response Management System (DRMS)...\n');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function generateSecret(bytes) {
  return crypto.randomBytes(bytes).toString('base64');
}

async function promptUser(question) {
  return new Promise((resolve) => {
    rl.question(question, (answer) => {
      resolve(answer);
    });
  });
}

async function setupProductionEnv() {
  try {
    console.log('üìã Production Environment Setup\n');
    
    // Check if .env.production exists
    if (fs.existsSync('.env.production')) {
      const overwrite = await promptUser('‚ö†Ô∏è  .env.production already exists. Overwrite? (y/N): ');
      if (overwrite.toLowerCase() !== 'y') {
        console.log('Setup cancelled. Existing .env.production preserved.');
        rl.close();
        return;
      }
    }

    console.log('üîë Generating secure secrets...');
    const jwtSecret = generateSecret(48); // 64 base64 characters
    const nextauthSecret = generateSecret(24); // 32 base64 characters
    
    console.log('‚úÖ Secrets generated successfully\n');

    // Get production configuration
    const config = {
      appName: 'Disaster Response Management System (DRMS)',
      appVersion: '1.0.0',
      domain: await promptUser('üåê Production domain (e.g., drms.example.com): ') || 'localhost:3000',
      dbHost: await promptUser('üóÑÔ∏è  Database host (e.g., prod-db.example.com): ') || 'localhost',
      dbName: await promptUser('üìä Database name [drms_prod]: ') || 'drms_prod',
      dbUser: await promptUser('üë§ Database user [drms_user]: ') || 'drms_user',
      dbPassword: await promptUser('üîí Database password: ') || 'CHANGE_ME_DB_PASSWORD'
    };

    const protocol = config.domain.includes('localhost') ? 'http' : 'https';
    const nextauthUrl = `${protocol}://${config.domain}`;
    const apiUrl = `${nextauthUrl}/api`;
    const databaseUrl = `postgresql://${config.dbUser}:${config.dbPassword}@${config.dbHost}:5432/${config.dbName}?schema=public${config.domain.includes('localhost') ? '' : '&sslmode=require'}`;

    // Generate .env.production content
    const envContent = `# Production Environment Configuration - DRMS
# Generated on ${new Date().toISOString()}

# ===========================================
# APPLICATION SETTINGS
# ===========================================
NEXT_PUBLIC_APP_NAME="${config.appName}"
NEXT_PUBLIC_APP_VERSION="${config.appVersion}"
NODE_ENV=production

# ===========================================
# PWA SETTINGS
# ===========================================
NEXT_PUBLIC_PWA_ENABLED=true

# ===========================================
# DATABASE CONFIGURATION
# ===========================================
DATABASE_URL="${databaseUrl}"

# ===========================================
# AUTHENTICATION & SECURITY
# ===========================================
JWT_SECRET="${jwtSecret}"
JWT_EXPIRES_IN="24h"
NEXTAUTH_SECRET="${nextauthSecret}"
NEXTAUTH_URL="${nextauthUrl}"

# ===========================================
# API SETTINGS
# ===========================================
NEXT_PUBLIC_API_URL="${apiUrl}"

# ===========================================
# SECURITY & PERFORMANCE
# ===========================================
ENABLE_SECURITY_HEADERS=true

# ===========================================
# DEPLOYMENT INFO
# ===========================================
# Generated by: DRMS Production Setup Script
# Domain: ${config.domain}
# Database: ${config.dbName} on ${config.dbHost}
# Setup Date: ${new Date().toISOString()}
`;

    // Write .env.production file
    fs.writeFileSync('.env.production', envContent);
    
    console.log('\n‚úÖ Production environment configured successfully!');
    console.log('\nüìã Configuration Summary:');
    console.log(`   App: ${config.appName}`);
    console.log(`   Domain: ${config.domain}`);
    console.log(`   Database: ${config.dbName} on ${config.dbHost}`);
    console.log(`   NextAuth URL: ${nextauthUrl}`);
    console.log(`   API URL: ${apiUrl}`);
    
    console.log('\nüîë Security Notes:');
    console.log('   ‚úÖ JWT Secret: Generated (64 chars)');
    console.log('   ‚úÖ NextAuth Secret: Generated (32 chars)');
    console.log('   ‚ö†Ô∏è  Database Password: Please use a strong password');
    
    console.log('\nüìã Next Steps:');
    console.log('   1. Review .env.production file');
    console.log('   2. Update database password if needed');
    console.log('   3. Set up production database');
    console.log('   4. Configure SSL certificates (if using HTTPS)');
    console.log('   5. Run: npm run build:production:ignore-ts');
    console.log('   6. Deploy with: docker-compose -f docker-compose.production.yml up -d');
    
    console.log('\nüöÄ DRMS is ready for production deployment!');

  } catch (error) {
    console.error('‚ùå Setup failed:', error.message);
    process.exit(1);
  } finally {
    rl.close();
  }
}

if (require.main === module) {
  setupProductionEnv();
}

module.exports = { setupProductionEnv };