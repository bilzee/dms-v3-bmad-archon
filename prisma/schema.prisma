// Disaster Management PWA - Database Schema
// This is your Prisma schema file, learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User Management Models
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  username     String   @unique
  passwordHash String
  name         String
  phone        String?
  organization String?
  isActive     Boolean  @default(true)
  isLocked     Boolean  @default(false)
  lastLogin    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  roles            UserRole[]
  entityAssignments EntityAssignment[]
  auditLogs        AuditLog[]
  responses        RapidResponse[]
  
  @@map("users")
}

model Role {
  id          String @id @default(cuid())
  name        RoleName @unique
  description String
  createdAt   DateTime @default(now())

  // Relationships
  userRoles   UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Permission {
  id          String @id @default(cuid())
  name        String
  code        String @unique
  category    String
  description String
  createdAt   DateTime @default(now())

  // Relationships
  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  // Relationships
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// Entity Management
model Entity {
  id          String     @id @default(cuid())
  name        String
  type        EntityType
  location    String?
  coordinates Json?
  metadata    Json?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relationships
  assignments        EntityAssignment[]
  rapidAssessments   RapidAssessment[]
  responses          RapidResponse[]

  @@unique([name, type])
  @@map("entities")
}

model EntityAssignment {
  id       String @id @default(cuid())
  userId   String
  entityId String
  assignedAt DateTime @default(now())
  assignedBy String

  // Relationships
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([userId, entityId])
  @@map("entity_assignments")
}

// Incident Management
model Incident {
  id                   String   @id @default(cuid())
  type                 String
  subType              String?
  severity             Priority @default(MEDIUM)
  status               IncidentStatus @default(ACTIVE)
  description          String
  location             String
  coordinates          Json?
  createdBy            String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relationships
  preliminaryAssessments PreliminaryAssessment[]

  @@map("incidents")
}

model PreliminaryAssessment {
  id                              String   @id @default(cuid())
  reportingDate                   DateTime
  reportingLatitude               Float
  reportingLongitude              Float
  reportingLGA                    String
  reportingWard                   String
  numberLivesLost                 Int      @default(0)
  numberInjured                   Int      @default(0)
  numberDisplaced                 Int      @default(0)
  numberHousesAffected            Int      @default(0)
  numberSchoolsAffected           Int      @default(0)
  schoolsAffected                 String?  // List of affected schools
  numberMedicalFacilitiesAffected Int      @default(0)
  medicalFacilitiesAffected       String?  // List of affected medical facilities
  estimatedAgriculturalLandsAffected String? // Description/estimate of agricultural impact
  reportingAgent                  String   // LEMC agent or staff name
  additionalDetails               Json?
  incidentId                      String?  // Nullable - preliminary assessments can predate incidents
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt
  
  // Relationships
  incident                        Incident? @relation(fields: [incidentId], references: [id])

  @@map("preliminary_assessments")
}

// Assessment and Response Models
model RapidAssessment {
  id                    String   @id @default(cuid())
  rapidAssessmentType   String   // Health, WASH, Shelter, Security, Food, Population, Other
  rapidAssessmentDate   DateTime
  affectedEntityId      String
  assessorName          String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  affectedEntity        Entity   @relation(fields: [affectedEntityId], references: [id])
  
  // Related assessment details (one-to-one relationships)
  healthAssessment      HealthAssessment?
  populationAssessment  PopulationAssessment?
  foodAssessment        FoodAssessment?
  washAssessment        WASHAssessment?
  shelterAssessment     ShelterAssessment?
  securityAssessment    SecurityAssessment?

  // Enhanced indexes for assessment queries
  @@index([rapidAssessmentType, rapidAssessmentDate, affectedEntityId])
  @@index([affectedEntityId, rapidAssessmentDate])
  @@index([createdAt, rapidAssessmentType])
  @@index([rapidAssessmentDate, rapidAssessmentType])
  @@map("rapid_assessments")
}

// Assessment Type Models (Type-Safe Implementation)

model HealthAssessment {
  rapidAssessmentId         String   @id
  hasFunctionalClinic       Boolean
  numberHealthFacilities    Int
  healthFacilityType        String
  qualifiedHealthWorkers    Int
  hasMedicineSupply         Boolean
  hasMedicalSupplies        Boolean
  hasMaternalChildServices  Boolean
  commonHealthIssues        String   @default("[]") // JSON string array: Diarrhea, Malaria, Respiratory, Malnutrition, Other
  additionalHealthDetails   String   @default("{}")
  rapidAssessment           RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)
  @@map("health_assessments")
}

model PopulationAssessment {
  rapidAssessmentId             String   @id
  totalHouseholds               Int
  totalPopulation               Int
  populationMale                Int
  populationFemale              Int
  populationUnder5              Int
  pregnantWomen                 Int
  lactatingMothers              Int
  personWithDisability          Int
  elderlyPersons                Int
  separatedChildren             Int
  numberLivesLost               Int
  numberInjured                 Int
  additionalPopulationDetails   String   @default("{}")
  rapidAssessment               RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)
  @@map("population_assessments")
}

model FoodAssessment {
  rapidAssessmentId                   String   @id
  foodSource                          String   @default("[]") // JSON string array: Government kitchen, Humanitarian Partners, Community, Individuals, Other
  availableFoodDurationDays           Int      // How long will available food last
  additionalFoodRequiredPersons       Int      // Additional food needed in terms of persons
  additionalFoodRequiredHouseholds    Int      // Additional food needed in terms of households
  additionalFoodDetails               String   @default("{}")
  rapidAssessment                     RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)
  @@map("food_assessments")
}

model WASHAssessment {
  rapidAssessmentId           String   @id
  waterSource                 String   @default("[]") // JSON string array: Borehole, River/Stream, Water trucks, Tap water, Sachet water, Other
  isWaterSufficient           Boolean  // Available water sufficiency
  functionalLatrinesAvailable Int      // Number of functional latrines
  areLatrinesSufficient       Boolean
  hasOpenDefecationConcerns   Boolean
  additionalWashDetails       String   @default("{}")
  rapidAssessment             RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)
  @@map("wash_assessments")
}

model ShelterAssessment {
  rapidAssessmentId         String   @id
  areSheltersSufficient     Boolean
  shelterTypes              String   @default("[]") // JSON string array: Trampoline, Open space, Local materials, Communal structure, Other
  requiredShelterType       String   @default("[]") // JSON string array: Required shelter types
  numberSheltersRequired    Int      // Estimated number required if insufficient
  areOvercrowded            Boolean
  provideWeatherProtection  Boolean
  additionalShelterDetails  String   @default("{}")
  rapidAssessment           RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)
  @@map("shelter_assessments")
}

model SecurityAssessment {
  rapidAssessmentId                 String   @id
  gbvCasesReported                  Boolean
  hasProtectionReportingMechanism   Boolean
  vulnerableGroupsHaveAccess        Boolean
  additionalSecurityDetails         String   @default("{}")
  rapidAssessment                   RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)
  @@map("security_assessments")
}

model RapidResponse {
  id              String          @id @default(cuid())
  responderId     String
  entityId        String
  assessmentId    String?
  type            ResponseType
  priority        Priority        @default(MEDIUM)
  status          ResponseStatus  @default(PLANNED)
  description     String
  resources       Json?
  timeline        Json?
  versionNumber   Int             @default(1)
  isOfflineCreated Boolean        @default(false)
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt      DateTime?
  verifiedBy      String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relationships
  responder       User     @relation(fields: [responderId], references: [id])
  entity          Entity   @relation(fields: [entityId], references: [id])

  @@map("rapid_responses")
}

// Synchronization and Conflict Management
model SyncConflict {
  id                    String   @id @default(cuid())
  entityType            String
  entityId              String
  conflictDate          DateTime @default(now())
  resolutionMethod      String   @default("LAST_WRITE_WINS")
  winningVersion        Json
  losingVersion         Json
  resolvedAt            DateTime @default(now())
  coordinatorNotified   Boolean  @default(false)
  coordinatorNotifiedAt DateTime?

  @@map("sync_conflicts")
}

// Audit and Logging
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  resource  String
  resourceId String?
  oldValues Json?
  newValues Json?
  timestamp DateTime @default(now())
  ipAddress String?
  userAgent String?

  // Relationships
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// Enums
enum RoleName {
  ASSESSOR
  COORDINATOR
  RESPONDER
  DONOR
  ADMIN
}

enum EntityType {
  COMMUNITY
  WARD
  LGA
  STATE
  FACILITY
  CAMP
}

enum AssessmentType {
  RAPID_HEALTH
  RAPID_WASH
  RAPID_SHELTER
  RAPID_FOOD
  RAPID_PROTECTION
  RAPID_EDUCATION
}

enum ResponseType {
  MEDICAL
  WASH
  SHELTER
  FOOD
  PROTECTION
  EDUCATION
  LOGISTICS
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  PUBLISHED
}

enum ResponseStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVIEW
}

enum IncidentStatus {
  ACTIVE
  CONTAINED
  RESOLVED
}