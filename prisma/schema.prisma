// Disaster Management PWA - Database Schema
// This is your Prisma schema file, learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User Management Models
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  username     String   @unique
  passwordHash String
  name         String
  phone        String?
  organization String?
  isActive     Boolean  @default(true)
  isLocked     Boolean  @default(false)
  lastLogin    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  roles            UserRole[]
  entityAssignments EntityAssignment[]
  auditLogs        AuditLog[]
  assessments      RapidAssessment[]
  responses        RapidResponse[]
  
  @@map("users")
}

model Role {
  id          String @id @default(cuid())
  name        RoleName @unique
  description String
  createdAt   DateTime @default(now())

  // Relationships
  userRoles   UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Permission {
  id          String @id @default(cuid())
  name        String
  code        String @unique
  category    String
  description String
  createdAt   DateTime @default(now())

  // Relationships
  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  // Relationships
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// Entity Management
model Entity {
  id          String     @id @default(cuid())
  name        String
  type        EntityType
  location    String?
  coordinates Json?
  metadata    Json?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relationships
  assignments  EntityAssignment[]
  assessments  RapidAssessment[]
  responses    RapidResponse[]

  @@map("entities")
}

model EntityAssignment {
  id       String @id @default(cuid())
  userId   String
  entityId String
  assignedAt DateTime @default(now())
  assignedBy String

  // Relationships
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([userId, entityId])
  @@map("entity_assignments")
}

// Incident Management
model Incident {
  id                   String   @id @default(cuid())
  type                 String
  subType              String?
  severity             Priority @default(MEDIUM)
  status               IncidentStatus @default(ACTIVE)
  description          String
  location             String
  coordinates          Json?
  createdBy            String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relationships
  preliminaryAssessments PreliminaryAssessment[]

  @@map("incidents")
}

model PreliminaryAssessment {
  id                              String   @id @default(cuid())
  reportingDate                   DateTime
  reportingLatitude               Float
  reportingLongitude              Float
  reportingLGA                    String
  reportingWard                   String
  numberLivesLost                 Int      @default(0)
  numberInjured                   Int      @default(0)
  numberDisplaced                 Int      @default(0)
  numberHousesAffected            Int      @default(0)
  numberSchoolsAffected           Int      @default(0)
  schoolsAffected                 String?  // List of affected schools
  numberMedicalFacilitiesAffected Int      @default(0)
  medicalFacilitiesAffected       String?  // List of affected medical facilities
  estimatedAgriculturalLandsAffected String? // Description/estimate of agricultural impact
  reportingAgent                  String   // LEMC agent or staff name
  additionalDetails               Json?
  incidentId                      String?  // Nullable - preliminary assessments can predate incidents
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt
  
  // Relationships
  incident                        Incident? @relation(fields: [incidentId], references: [id])

  @@map("preliminary_assessments")
}

// Assessment and Response Models
model RapidAssessment {
  id              String          @id @default(cuid())
  assessorId      String
  entityId        String
  type            AssessmentType
  priority        Priority        @default(MEDIUM)
  status          AssessmentStatus @default(DRAFT)
  location        String?
  coordinates     Json?
  data            Json
  versionNumber   Int             @default(1)
  isOfflineCreated Boolean        @default(false)
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt      DateTime?
  verifiedBy      String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relationships
  assessor        User     @relation(fields: [assessorId], references: [id])
  entity          Entity   @relation(fields: [entityId], references: [id])
  responses       RapidResponse[]

  @@map("rapid_assessments")
}

model RapidResponse {
  id              String          @id @default(cuid())
  responderId     String
  entityId        String
  assessmentId    String?
  type            ResponseType
  priority        Priority        @default(MEDIUM)
  status          ResponseStatus  @default(PLANNED)
  description     String
  resources       Json?
  timeline        Json?
  versionNumber   Int             @default(1)
  isOfflineCreated Boolean        @default(false)
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt      DateTime?
  verifiedBy      String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relationships
  responder       User     @relation(fields: [responderId], references: [id])
  entity          Entity   @relation(fields: [entityId], references: [id])
  assessment      RapidAssessment? @relation(fields: [assessmentId], references: [id])

  @@map("rapid_responses")
}

// Synchronization and Conflict Management
model SyncConflict {
  id                    String   @id @default(cuid())
  entityType            String
  entityId              String
  conflictDate          DateTime @default(now())
  resolutionMethod      String   @default("LAST_WRITE_WINS")
  winningVersion        Json
  losingVersion         Json
  resolvedAt            DateTime @default(now())
  coordinatorNotified   Boolean  @default(false)
  coordinatorNotifiedAt DateTime?

  @@map("sync_conflicts")
}

// Audit and Logging
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  resource  String
  resourceId String?
  oldValues Json?
  newValues Json?
  timestamp DateTime @default(now())
  ipAddress String?
  userAgent String?

  // Relationships
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// Enums
enum RoleName {
  ASSESSOR
  COORDINATOR
  RESPONDER
  DONOR
  ADMIN
}

enum EntityType {
  COMMUNITY
  WARD
  LGA
  STATE
  FACILITY
  CAMP
}

enum AssessmentType {
  RAPID_HEALTH
  RAPID_WASH
  RAPID_SHELTER
  RAPID_FOOD
  RAPID_PROTECTION
  RAPID_EDUCATION
}

enum ResponseType {
  MEDICAL
  WASH
  SHELTER
  FOOD
  PROTECTION
  EDUCATION
  LOGISTICS
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  PUBLISHED
}

enum ResponseStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVIEW
}

enum IncidentStatus {
  ACTIVE
  CONTAINED
  RESOLVED
}