generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ReportTemplate {
  id             String                @id @default(uuid())
  name           String
  description    String?
  type           ReportType            @default(CUSTOM)
  layout         Json
  createdById    String
  isPublic       Boolean               @default(false)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  configurations ReportConfiguration[]
  createdBy      User                  @relation("ReportTemplates", fields: [createdById], references: [id])

  @@map("report_templates")
}

model ReportConfiguration {
  id             String            @id @default(uuid())
  templateId     String
  name           String
  filters        Json
  aggregations   Json
  visualizations Json
  schedule       Json?
  createdBy      String
  createdAt      DateTime          @default(now())
  creator        User              @relation("ReportConfigurations", fields: [createdBy], references: [id])
  template       ReportTemplate    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  executions     ReportExecution[]

  @@map("report_configurations")
}

model ReportExecution {
  id              String                @id @default(uuid())
  configurationId String
  status          ReportExecutionStatus @default(PENDING)
  format          ReportFormat
  filePath        String?
  generatedAt     DateTime?
  error           String?
  createdAt       DateTime              @default(now())
  configuration   ReportConfiguration   @relation(fields: [configurationId], references: [id], onDelete: Cascade)

  @@map("report_executions")
}

model User {
  id                        String                @id @default(uuid())
  email                     String                @unique
  username                  String                @unique
  passwordHash              String
  name                      String
  phone                     String?
  organization              String?
  isActive                  Boolean               @default(true)
  isLocked                  Boolean               @default(false)
  lastLogin                 DateTime?
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  auditLogs                 AuditLog[]
  entityAssignments         EntityAssignment[]
  gapFieldSeveritiesCreated GapFieldSeverity[]    @relation("GapFieldSeverityCreatedBy")
  gapFieldSeveritiesUpdated GapFieldSeverity[]    @relation("GapFieldSeverityUpdatedBy")
  assessments               RapidAssessment[]     @relation("AssessorResponses")
  responses                 RapidResponse[]       @relation("UserResponses")
  reportConfigurations      ReportConfiguration[] @relation("ReportConfigurations")
  reportTemplates           ReportTemplate[]      @relation("ReportTemplates")
  roles                     UserRole[]

  @@map("users")
}

model Role {
  id          String           @id @default(uuid())
  name        RoleName         @unique
  description String
  createdAt   DateTime         @default(now())
  permissions RolePermission[]
  userRoles   UserRole[]

  @@map("roles")
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Permission {
  id          String           @id @default(uuid())
  name        String
  code        String           @unique
  category    String
  description String
  createdAt   DateTime         @default(now())
  roles       RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model Entity {
  id                 String             @id @default(uuid())
  name               String
  type               EntityType
  location           String?
  coordinates        Json?
  metadata           Json?
  isActive           Boolean            @default(true)
  autoApproveEnabled Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  commitments        DonorCommitment[]
  assignments        EntityAssignment[]
  rapidAssessments   RapidAssessment[]
  responses          RapidResponse[]    @relation("EntityResponses")

  @@unique([name, type])
  @@map("entities")
}

model EntityAssignment {
  id         String   @id @default(uuid())
  userId     String
  entityId   String
  assignedAt DateTime @default(now())
  assignedBy String
  entity     Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, entityId])
  @@map("entity_assignments")
}

model Incident {
  id                     String                  @id @default(uuid())
  name                   String
  type                   String
  subType                String?
  severity               Priority                @default(MEDIUM)
  status                 IncidentStatus          @default(ACTIVE)
  description            String
  location               String
  coordinates            Json?
  createdBy              String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  commitments            DonorCommitment[]
  preliminaryAssessments PreliminaryAssessment[]
  rapidAssessments       RapidAssessment[]

  @@map("incidents")
}

model PreliminaryAssessment {
  id                                 String    @id @default(uuid())
  reportingDate                      DateTime
  reportingLatitude                  Float
  reportingLongitude                 Float
  reportingLGA                       String
  reportingWard                      String
  numberLivesLost                    Int       @default(0)
  numberInjured                      Int       @default(0)
  numberDisplaced                    Int       @default(0)
  numberHousesAffected               Int       @default(0)
  numberSchoolsAffected              Int       @default(0)
  schoolsAffected                    String?
  numberMedicalFacilitiesAffected    Int       @default(0)
  medicalFacilitiesAffected          String?
  estimatedAgriculturalLandsAffected String?
  reportingAgent                     String
  additionalDetails                  Json?
  incidentId                         String?
  createdAt                          DateTime  @default(now())
  updatedAt                          DateTime  @updatedAt
  incident                           Incident? @relation(fields: [incidentId], references: [id])

  @@map("preliminary_assessments")
}

model RapidAssessment {
  id                   String                @id @default(uuid())
  rapidAssessmentType  AssessmentType
  rapidAssessmentDate  DateTime
  assessorId           String
  entityId             String
  assessorName         String
  location             String?
  coordinates          Json?
  status               AssessmentStatus      @default(DRAFT)
  priority             Priority              @default(MEDIUM)
  versionNumber        Int                   @default(1)
  isOfflineCreated     Boolean               @default(false)
  syncStatus           SyncStatus            @default(PENDING)
  verificationStatus   VerificationStatus    @default(DRAFT)
  verifiedAt           DateTime?
  verifiedBy           String?
  rejectionReason      String?
  rejectionFeedback    String?
  mediaAttachments     Json?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  gapAnalysis          Json?
  incidentId           String
  foodAssessment       FoodAssessment?
  healthAssessment     HealthAssessment?
  populationAssessment PopulationAssessment?
  assessor             User                  @relation("AssessorResponses", fields: [assessorId], references: [id])
  entity               Entity                @relation(fields: [entityId], references: [id])
  incident             Incident              @relation(fields: [incidentId], references: [id])
  responses            RapidResponse[]       @relation("AssessmentResponses")
  securityAssessment   SecurityAssessment?
  shelterAssessment    ShelterAssessment?
  washAssessment       WASHAssessment?

  @@index([rapidAssessmentType, rapidAssessmentDate, entityId])
  @@index([entityId, rapidAssessmentDate])
  @@index([incidentId, rapidAssessmentDate])
  @@index([incidentId, entityId])
  @@index([assessorId, createdAt])
  @@index([status, priority])
  @@index([createdAt, rapidAssessmentType])
  @@index([rapidAssessmentDate, rapidAssessmentType])
  @@index([syncStatus, isOfflineCreated])
  @@map("rapid_assessments")
}

model HealthAssessment {
  rapidAssessmentId        String          @id
  hasFunctionalClinic      Boolean
  hasEmergencyServices     Boolean
  numberHealthFacilities   Int
  healthFacilityType       String
  qualifiedHealthWorkers   Int
  hasTrainedStaff          Boolean
  hasMedicineSupply        Boolean
  hasMedicalSupplies       Boolean
  hasMaternalChildServices Boolean
  commonHealthIssues       String          @default("[]")
  additionalHealthDetails  Json?
  rapidAssessment          RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)

  @@map("health_assessments")
}

model PopulationAssessment {
  rapidAssessmentId           String          @id
  totalHouseholds             Int
  totalPopulation             Int
  populationMale              Int
  populationFemale            Int
  populationUnder5            Int
  pregnantWomen               Int
  lactatingMothers            Int
  personWithDisability        Int
  elderlyPersons              Int
  separatedChildren           Int
  numberLivesLost             Int
  numberInjured               Int
  additionalPopulationDetails String?
  rapidAssessment             RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)

  @@map("population_assessments")
}

model FoodAssessment {
  rapidAssessmentId                String          @id
  isFoodSufficient                 Boolean
  hasRegularMealAccess             Boolean
  hasInfantNutrition               Boolean
  foodSource                       String          @default("[]")
  availableFoodDurationDays        Int
  additionalFoodRequiredPersons    Int
  additionalFoodRequiredHouseholds Int
  additionalFoodDetails            Json?
  rapidAssessment                  RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)

  @@map("food_assessments")
}

model WASHAssessment {
  rapidAssessmentId           String          @id
  waterSource                 String          @default("[]")
  isWaterSufficient           Boolean
  hasCleanWaterAccess         Boolean
  functionalLatrinesAvailable Int
  areLatrinesSufficient       Boolean
  hasHandwashingFacilities    Boolean
  hasOpenDefecationConcerns   Boolean
  additionalWashDetails       Json?
  rapidAssessment             RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)

  @@map("wash_assessments")
}

model ShelterAssessment {
  rapidAssessmentId        String          @id
  areSheltersSufficient    Boolean
  hasSafeStructures        Boolean
  shelterTypes             String          @default("[]")
  requiredShelterType      String          @default("[]")
  numberSheltersRequired   Int
  areOvercrowded           Boolean
  provideWeatherProtection Boolean
  additionalShelterDetails Json?
  rapidAssessment          RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)

  @@map("shelter_assessments")
}

model SecurityAssessment {
  rapidAssessmentId               String          @id
  isSafeFromViolence              Boolean
  gbvCasesReported                Boolean
  hasSecurityPresence             Boolean
  hasProtectionReportingMechanism Boolean
  vulnerableGroupsHaveAccess      Boolean
  hasLighting                     Boolean
  additionalSecurityDetails       Json?
  rapidAssessment                 RapidAssessment @relation(fields: [rapidAssessmentId], references: [id], onDelete: Cascade)

  @@map("security_assessments")
}

model RapidResponse {
  id                 String             @id @default(uuid())
  responderId        String
  entityId           String
  assessmentId       String
  type               ResponseType
  priority           Priority           @default(MEDIUM)
  status             ResponseStatus     @default(PLANNED)
  description        String?
  resources          Json?
  timeline           Json?
  versionNumber      Int                @default(1)
  isOfflineCreated   Boolean            @default(false)
  verificationStatus VerificationStatus @default(DRAFT)
  verifiedAt         DateTime?
  verifiedBy         String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  donorId            String?
  commitmentId       String?
  items              Json
  offlineId          String?            @unique
  plannedDate        DateTime           @default(now())
  rejectionFeedback  String?
  rejectionReason    String?
  responseDate       DateTime?
  syncStatus         SyncStatus         @default(LOCAL)
  mediaAttachments   MediaAttachment[]
  assessment         RapidAssessment    @relation("AssessmentResponses", fields: [assessmentId], references: [id])
  commitment         DonorCommitment?   @relation("CommitmentResponses", fields: [commitmentId], references: [id])
  donor              Donor?             @relation("DonorResponses", fields: [donorId], references: [id])
  entity             Entity             @relation("EntityResponses", fields: [entityId], references: [id])
  responder          User               @relation("UserResponses", fields: [responderId], references: [id])
  conflicts          SyncConflict[]     @relation("ResponseConflicts")

  @@index([commitmentId])
  @@map("rapid_responses")
}

model Donor {
  id                       String            @id @default(uuid())
  name                     String
  type                     DonorType         @default(ORGANIZATION)
  contactEmail             String?
  contactPhone             String?
  organization             String?
  isActive                 Boolean           @default(true)
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  leaderboardRank          Int?              @default(0)
  selfReportedDeliveryRate Float?            @default(0)
  verifiedDeliveryRate     Float?            @default(0)
  commitments              DonorCommitment[]
  responses                RapidResponse[]   @relation("DonorResponses")

  @@map("donors")
}

model DonorCommitment {
  id                        String           @id @default(uuid())
  donorId                   String
  entityId                  String
  incidentId                String
  status                    CommitmentStatus @default(PLANNED)
  items                     Json
  totalCommittedQuantity    Int              @default(0)
  deliveredQuantity         Int              @default(0)
  verifiedDeliveredQuantity Int              @default(0)
  commitmentDate            DateTime         @default(now())
  lastUpdated               DateTime         @updatedAt
  notes                     String?
  totalValueEstimated       Float?           @default(0)
  donor                     Donor            @relation(fields: [donorId], references: [id])
  entity                    Entity           @relation(fields: [entityId], references: [id])
  incident                  Incident         @relation(fields: [incidentId], references: [id])
  responses                 RapidResponse[]  @relation("CommitmentResponses")

  @@index([donorId, entityId])
  @@index([donorId, incidentId])
  @@index([status])
  @@index([entityId, incidentId])
  @@map("donor_commitments")
}

model MediaAttachment {
  id            String        @id @default(uuid())
  responseId    String
  filename      String
  originalName  String
  mimeType      String
  fileSize      Int
  filePath      String
  thumbnailPath String?
  uploadedAt    DateTime      @default(now())
  uploadedBy    String
  response      RapidResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@map("media_attachments")
}

model SyncConflict {
  id                    String         @id @default(uuid())
  entityType            String
  entityId              String
  conflictDate          DateTime       @default(now())
  resolutionMethod      String         @default("LAST_WRITE_WINS")
  winningVersion        Json
  losingVersion         Json
  resolvedAt            DateTime       @default(now())
  coordinatorNotified   Boolean        @default(false)
  coordinatorNotifiedAt DateTime?
  responseId            String?
  response              RapidResponse? @relation("ResponseConflicts", fields: [responseId], references: [id])

  @@map("sync_conflicts")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  resource   String
  resourceId String?
  oldValues  Json?
  newValues  Json?
  timestamp  DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  user       User?    @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model GapFieldSeverity {
  id             String         @id @default(uuid())
  fieldName      String         @map("field_name")
  assessmentType AssessmentType @map("assessment_type")
  severity       Priority       @default(MEDIUM)
  displayName    String         @map("display_name")
  description    String?
  isActive       Boolean        @default(true) @map("is_active")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  createdBy      String?        @map("created_by")
  updatedBy      String?        @map("updated_by")
  createdByUser  User?          @relation("GapFieldSeverityCreatedBy", fields: [createdBy], references: [id])
  updatedByUser  User?          @relation("GapFieldSeverityUpdatedBy", fields: [updatedBy], references: [id])

  @@unique([fieldName, assessmentType], name: "unique_field_assessment")
  @@index([assessmentType], map: "idx_assessment_type")
  @@index([severity], map: "idx_severity")
  @@index([isActive], map: "idx_active")
  @@map("gap_field_severities")
}

enum RoleName {
  ASSESSOR
  COORDINATOR
  RESPONDER
  DONOR
  ADMIN
}

enum EntityType {
  COMMUNITY
  WARD
  LGA
  STATE
  FACILITY
  CAMP
}

enum AssessmentType {
  HEALTH
  WASH
  SHELTER
  FOOD
  SECURITY
  POPULATION
}

enum ResponseType {
  HEALTH
  WASH
  SHELTER
  FOOD
  SECURITY
  POPULATION
  LOGISTICS
}

enum ResponseStatus {
  PLANNED
  DELIVERED
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  PUBLISHED
}

enum VerificationStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  AUTO_VERIFIED
  REJECTED
}

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  FAILED
  CONFLICT
  LOCAL
}

enum DonorType {
  INDIVIDUAL
  ORGANIZATION
  GOVERNMENT
  NGO
  CORPORATE
}

enum IncidentStatus {
  ACTIVE
  CONTAINED
  RESOLVED
}

enum CommitmentStatus {
  PLANNED
  PARTIAL
  COMPLETE
  CANCELLED
}

enum ReportType {
  ASSESSMENT
  RESPONSE
  ENTITY
  DONOR
  CUSTOM
}

enum ReportExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum ReportFormat {
  PDF
  CSV
  HTML
  EXCEL
}
